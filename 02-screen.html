<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>モニターPro - 02 三送会</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* 01-screen.html 3.txt のスタイルを継承 */
        #lyrics-guide { 
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            font-size: 3.5vmin;
            color: rgba(255,255,255,0.7) !important;
            margin-bottom: 1vh;
            min-height: 1.2em;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }
        #action-label { 
            font-family: "Hiragino Sans", "Meiryo", sans-serif;
            font-size: 8vmin;
            font-weight: bold; 
            margin-bottom: 0vh;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 0.1em;
            flex-shrink: 0;
        }
        #name-label { 
            font-family: "Hiragino Sans", "Meiryo", sans-serif;
            font-size: 16vmin; 
            font-weight: 900; 
            line-height: 1.1; 
            white-space: pre-wrap; 
            text-shadow: 4px 4px 10px rgba(0,0,0,0.8);
            width: 95%;
            word-wrap: break-word;
        }
        .btn-row { display: flex; gap: 15px; width: 95%; max-width: 600px; justify-content: center; }
        
        /* 【重要】動画同期バグ対策
           visibility: hidden; だとブラウザが更新を止めてしまうため、
           opacity: 0; で「見えないが存在する」状態にします。
        */
        #player-wrapper { 
            position: fixed;
            top: 0; left: 0;
            width: 1px; height: 1px;
            opacity: 0;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body class="monitor-body bg-black">

    <div id="header-controls">
        <a href="index.html" id="back-to-index-btn">← 戻る</a>
        <button id="fullscreen-btn" onclick="toggleFullScreen()">全画面</button>
    </div>

    <div id="start-overlay" onclick="startPerformance()">
        <div class="big-start-btn">
            練習開始<br>
            <span style="font-size:1.2rem; font-weight:normal; display:block; margin-top:10px;">(画面をタップ)</span>
        </div>
    </div>

    <div id="monitor-container">
        <div id="lyrics-guide"></div>
        <span id="action-label">READY</span>
        <span id="name-label">...</span>
    </div>

    <div id="controls">
        <input type="range" id="seek-bar" value="0" step="0.1">
        <div class="btn-row">
            <button class="ctrl-btn" onclick="skip(-10)">-10秒</button>
            <button class="ctrl-btn" id="play-pause-btn" onclick="togglePlay()">一時停止</button>
            <button class="ctrl-btn" onclick="skip(10)">+10秒</button>
        </div>
    </div>
    
    <div id="player-wrapper">
        <video id="video-player" playsinline>
            <source src="https://res.cloudinary.com/doqthalka/video/upload/v1771151605/%E4%B8%89%E9%80%81%E4%BC%9A_vag4dh.mp4" type="video/mp4">
        </video>
    </div>

    <script src="data02.js"></script>

    <script>
        // --- 設定・準備 ---
        const video = document.getElementById('video-player');
        const lyricsEl = document.getElementById('lyrics-guide');
        const actionEl = document.getElementById('action-label');
        const nameEl = document.getElementById('name-label');
        const seekBar = document.getElementById('seek-bar');
        const container = document.getElementById('monitor-container');

        // エラーチェック: data02.js が正しく読み込まれたか？
        let dataSec = [];
        if (typeof performanceData02 === 'undefined') {
            alert("【エラー】data02.js が読み込めませんでした。\nHTMLと同じフォルダに data02.js があるか確認してください。");
            nameEl.innerText = "DATA ERROR";
        } else {
            // データを秒数変換して準備
            dataSec = performanceData02.map(d => ({
                s: parseTime(d[0]), l: d[1], m: d[2]
            }));
        }

        // 時間変換関数 ("01:23" -> 83秒)
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        // 色判定ロジック (script.jsがなくても動くように内蔵)
        function getMemoInfo(memo) {
            let bgClass = "bg-black";
            let isPrep = false;
            if (!memo) return { bgClass, isPrep };
            
            if (memo.includes("赤")) bgClass = "bg-red";
            else if (memo.includes("青")) bgClass = "bg-blue";
            else if (memo.includes("緑")) bgClass = "bg-green";
            else if (memo.includes("橙") || memo.includes("オレンジ")) bgClass = "bg-orange";
            else if (memo.includes("紫")) bgClass = "bg-purple";
            else if (memo.includes("準備")) {
                isPrep = true;
                if (memo.includes("赤")) bgClass = "bg-red-prep";
                else if (memo.includes("青")) bgClass = "bg-blue-prep";
                else bgClass = "bg-black";
            }
            return { bgClass, isPrep };
        }

        // --- イベント設定 ---

        // 動画の長さがわかったらシークバー設定
        video.addEventListener('loadedmetadata', () => {
            seekBar.max = video.duration;
        });

        // 【重要】同期の要：setIntervalで強制的に画面を更新する (100ms毎)
        // videoのtimeupdateイベントだけだと、画面オフ時などに止まることがあるため
        setInterval(updateMonitor, 100);

        // シークバー操作
        seekBar.addEventListener('input', () => {
            video.currentTime = seekBar.value;
        });

        // 開始ボタン
        function startPerformance() {
            document.getElementById('start-overlay').style.display = 'none';
            video.play().catch(e => {
                alert("再生エラー: 画面をもう一度タップしてください");
            });
            document.getElementById('play-pause-btn').innerText = "一時停止";
        }

        // 再生・一時停止
        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            if (!video.paused) {
                video.pause();
                btn.innerText = "再開";
                btn.style.backgroundColor = "#fff";
                btn.style.color = "#000";
            } else {
                video.play();
                btn.innerText = "一時停止";
                btn.style.backgroundColor = "";
                btn.style.color = "";
            }
        }

        // スキップ
        function skip(sec) {
            video.currentTime += sec;
        }

        // 全画面
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        }

        // --- 画面更新ロジック (メイン) ---
        function updateMonitor() {
            const currentTime = video.currentTime;
            
            // シークバーの更新 (操作中以外)
            if(document.activeElement !== seekBar) {
                seekBar.value = currentTime;
            }
            
            let lastMemoIndex = -1;
            let currentLyrics = "";

            // 現在の再生時間に対応するデータを探す
            for (let i = 0; i < dataSec.length; i++) {
                if (currentTime >= dataSec[i].s) {
                    currentLyrics = dataSec[i].l;
                    // メモがある行を記憶
                    if (dataSec[i].m && dataSec[i].m.trim() !== "") {
                        lastMemoIndex = i;
                    }
                } else {
                    break;
                }
            }

            // 歌詞表示
            lyricsEl.innerText = currentLyrics || "";

            // 指示と背景色更新
            if (lastMemoIndex !== -1) {
                let memo = dataSec[lastMemoIndex].m;
                const info = getMemoInfo(memo);
                
                let parts = memo.split(/[、]/);
                let action = parts[0] || "";
                let names = (parts[1] || "").replace(/・/g, '\n');

                actionEl.innerText = action;
                nameEl.innerText = names;

                if (info.isPrep) container.classList.add('is-prep');
                else container.classList.remove('is-prep');

                document.body.className = "monitor-body " + info.bgClass;
            }
        }
    </script>
</body>
</html>
